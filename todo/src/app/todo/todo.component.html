<mat-drawer-container autosize>
  <mat-drawer #drawer class="add-task-sidenav" mode="side" position="end" autoFocus="true">
    <mat-toolbar color="red">
      <mat-toolbar-row>
        <span>Add task</span>
        <span class="spacer"></span>
        <button mat-icon-button (click)="drawer.close(); resetForm();" [disabled]="!drawer.opened" color="warn" aria-label="Close sidenav">
          <mat-icon>close</mat-icon>
        </button>
      </mat-toolbar-row>
    </mat-toolbar>
    <div class="card">
      <form class="add-task-form" [formGroup]="addTaskForm" (ngSubmit)="submitTask(); drawer.close(); resetForm();" novalidate>
        <mat-form-field class="input-full-width">
          <mat-label>Title</mat-label>
          <input matInput placeholder="e.g. Call Nicholas" value="" formControlName="title" cdkFocusInitial>
          <mat-error *ngIf="errorHandling('title', 'required')">
            You must provide a <strong>title</strong>
          </mat-error>
        </mat-form-field>
        <mat-form-field class="input-full-width">
          <mat-label>Description</mat-label>
          <textarea matInput placeholder="e.g. The phone number to call is..." formControlName="description"></textarea>
        </mat-form-field>
        <mat-form-field class="input-full-width">
          <mat-label>Category</mat-label>
          <input matInput placeholder="e.g. Personal" value="" formControlName="category">
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Due date</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="dueDate" (dateChange)="onDateChange($event)">
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <div fxLayoutAlign="end center">
          <button mat-stroked-button [disabled]="!addTaskForm.valid">Add</button>
        </div>
      </form>
    </div>
  </mat-drawer>
  <div class="container" fxLayout="column" fxLayoutAlign="start center" fxFlexFill>
    <div class="card">
      <div fxLayout="column" fxLayoutAlign="start center">
        <button mat-button (click)="drawer.open()" [disabled]="drawer.opened" color="primary" aria-label="Add a new task">
          Add Task
        </button>
      </div>
    </div>
    <div class="card">
      <h2>Focused</h2>
      <mat-accordion id="focused-list" class="list" cdkDropList #focusedList="cdkDropList" [cdkDropListData]="focusedTasks" [cdkDropListConnectedTo]="[backlogList, doneList]" (cdkDropListDropped)="drop($event)">
        <ng-container *ngFor="let task of focusedTasks | async">
          <mat-expansion-panel cdkDrag [cdkDragData]="task" hideToggle>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-checkbox color="primary" disableRipple="true"
                  [checked]="task.isDone"
                  (change)="onDoneChange($event, task)"
                  (click)="$event.stopPropagation()"
                  (keydown)="$event.stopPropagation()">
                  {{ task.title }}
                </mat-checkbox>
              </mat-panel-title>
              <mat-panel-description>
                <span>{{ task.category }}</span>
                <button mat-icon-button aria-label="Unfocus task"
                  (click)="$event.stopPropagation(); onFocusChange($event, task)">
                  <mat-icon>flag</mat-icon>
                </button>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <p>{{ task.description }}</p>
            <p class="mat-expansion-panel-header-description">Due: {{ task.dueDate.seconds * 1000 | date }}</p>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </div>
    <div class="card">
      <h2>Backlog</h2>
      <mat-accordion id="backlog-list" class="list" cdkDropList #backlogList="cdkDropList" [cdkDropListData]="backlogTasks" [cdkDropListConnectedTo]="[focusedList, doneList]" (cdkDropListDropped)="drop($event)">
        <ng-container *ngFor="let task of backlogTasks | async">
          <mat-expansion-panel cdkDrag [cdkDragData]="task" hideToggle>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-checkbox color="primary" disableRipple="true"
                  [checked]="task.isDone"
                  (change)="onDoneChange($event, task)"
                  (click)="$event.stopPropagation()"
                  (keydown)="$event.stopPropagation()">
                  {{ task.title }}
                </mat-checkbox>
              </mat-panel-title>
              <mat-panel-description>
                <span>{{ task.category }}</span>
                <button mat-icon-button aria-label="Unfocus task"
                  (click)="$event.stopPropagation(); onFocusChange($event, task)">
                  <mat-icon>outlined_flag</mat-icon>
                </button>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <p>{{ task.description }}</p>
            <p class="mat-expansion-panel-header-description">Due: {{ task.dueDate.seconds * 1000 | date }}</p>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
      <button mat-icon-button (click)="drawer.open()" [disabled]="drawer.opened" color="primary" aria-label="Add a new task">
        <mat-icon>add</mat-icon>
      </button>
    </div>
    <div class="card">
      <h2>Done</h2>
      <mat-accordion id="done-list" class="list" cdkDropList #doneList="cdkDropList" [cdkDropListData]="doneTasks" [cdkDropListConnectedTo]="[focusedList, backlogList]" (cdkDropListDropped)="drop($event)">
        <ng-container *ngFor="let task of doneTasks | async">
          <mat-expansion-panel cdkDrag [cdkDragData]="task" hideToggle>
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-checkbox color="primary" disableRipple="true"
                  [checked]="task.isDone"
                  (change)="onDoneChange($event, task)"
                  (click)="$event.stopPropagation()"
                  (keydown)="$event.stopPropagation()">
                  {{ task.title }}
                </mat-checkbox>
              </mat-panel-title>
              <mat-panel-description>{{ task.category }}</mat-panel-description>
            </mat-expansion-panel-header>
            <p>{{ task.description }}</p>
          </mat-expansion-panel>
        </ng-container>
      </mat-accordion>
    </div>
  </div>
</mat-drawer-container>
